<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JimeBiso</title>
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.9.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.9.1/core.js"></script>
  <style>
    html, body { margin:0; padding:0; background: radial-gradient(ellipse at center, #05070d 0%, #02030a 60%, #000 100%); height:100%; overflow:hidden; }
    #hud { position: fixed; left: 16px; top: 12px; color: #cfe8ff; font: 600 16px/1.2 system-ui; text-shadow: 0 0 8px rgba(83,179,255,.35); z-index: 5; }
    #hud .title { font-weight: 800; letter-spacing: .5px; margin-bottom: 4px; }
    #hud .row { opacity: .9; }
    canvas { display:block; width:100vw; height:100vh; }
    #footer { position:fixed; right: 12px; bottom: 12px; color:#9ecaff; font: 12px/1.2 system-ui; opacity:.8 }
    #gameover {
      display:none;
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      color:white; text-align:center; font-family:system-ui;
      z-index:10; flex-direction:column; justify-content:center; align-items:center;
    }
    #gameover h1 { font-size:3em; margin-bottom:20px; }
    #gameover button { padding:10px 20px; font-size:1.2em; background:#9ecaff; border:none; border-radius:6px; cursor:pointer; }
    /* Popup for caught letter */
    #letterpopup {
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%, -50%);
      font-size:5em;
      font-weight:bold;
      color:#fff;
      text-shadow:0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(83,179,255,0.8);
      z-index:9;
      animation: popupfade 1s ease forwards;
    }
    @keyframes popupfade {
        0% { opacity:1; transform:translate(-50%, -50%) scale(1); }
        80% { opacity:1; transform:translate(-50%, -50%) scale(1.2); }
        100% { opacity:0; transform:translate(-50%, -50%) scale(1.5); }
    }
    #letterpopup {
        /* ...existing styles... */
        animation: popupfade 2.5s ease forwards; /* was 1s */
    }

  </style>
</head>
<body>
  <div id="hud">
    <div class="title">JimeBisoGame</div>
    <div class="row">Score: <span id="score">0</span> | Missed: <span id="missed">0</span></div>
    <div class="row">Best: <span id="best">0</span></div>
  </div>

  <canvas id="game"></canvas>
  <div id="letterpopup"></div>

  <div id="gameover">
    <h1>Game Over!</h1>
    <p>Your Score: <span id="finalscore">0</span></p>
    <button id="restart">Restart</button>
  </div>

  <audio id="bgmusic" loop autoplay>
    <source src="space-adventure-29296.mp3" type="audio/mpeg">
  </audio>
  <audio id="catchsound">
    <source src="iphone-camera-capture-6448.mp3" type="audio/mpeg">
  </audio>
  <audio id="gameoversound">
    <source src="darkness-122673.mp3" type="audio/mpeg">
  </audio>

  <py-config>
    packages = []
  </py-config>

  <py-script>
from js import document, window
from pyodide.ffi import create_proxy
from math import sin, cos, pi
import random

bg_music = document.getElementById("bgmusic")
catch_sound = document.getElementById("catchsound")
gameover_sound = document.getElementById("gameoversound")
canvas = document.getElementById("game")
ctx = canvas.getContext("2d")

hud_score = document.getElementById("score")
hud_missed = document.getElementById("missed")
hud_best = document.getElementById("best")
overlay = document.getElementById("gameover")
final_score = document.getElementById("finalscore")
restart_btn = document.getElementById("restart")
popup = document.getElementById("letterpopup")

game_over = False

def resize(*args):
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
resize_proxy = create_proxy(resize)
window.addEventListener("resize", resize_proxy)
resize()

letters = []
stars = []
score = 0
missed = 0
best = 0
hand_x = canvas.width / 2
hand_y = canvas.height * 0.82
hand_open = 1.0
grab_timer = 0
spawn_interval = 48
speed_min = 1.5
speed_max = 3.8
frame = 0

def on_move(e):
    global hand_x, hand_y
    if hasattr(e, "touches") and e.touches.length > 0:
        t = e.touches[0]
        hand_x = t.clientX
        hand_y = t.clientY
    else:
        hand_x = e.clientX
        hand_y = e.clientY
on_move_proxy = create_proxy(on_move)
window.addEventListener("mousemove", on_move_proxy)
window.addEventListener("touchmove", on_move_proxy)

for i in range(200):
    stars.append({"x": random.random(), "y": random.random(), "z": random.choice([0.2, 0.4, 0.7, 1.0])})

def draw_stars():
    w, h = canvas.width, canvas.height
    for s in stars:
        x = int(s["x"] * w)
        y = int(s["y"] * h)
        size = s["z"] * 1.8 + 0.2
        ctx.globalAlpha = 0.3 + 0.7 * s["z"]
        ctx.fillStyle = "#b9d8ff"
        ctx.fillRect(x, y, size, size)
    ctx.globalAlpha = 1.0

class Letter:
    def __init__(self):
        w = canvas.width
        self.x = random.uniform(20, w-20)
        self.y = -40
        self.speed = random.uniform(speed_min, speed_max)
        if random.random() < 0.2:
            self.ch = str(random.randint(0,9))
        else:
            self.ch = chr(random.randint(65, 90))
        self.size = random.uniform(24, 44)
        self.spin = random.uniform(-0.03, 0.03)
        self.angle = random.uniform(0, 2*pi)
    def update(self):
        self.y += self.speed
        self.angle += self.spin
    def draw(self):
        ctx.save()
        ctx.translate(self.x, self.y)
        ctx.rotate(self.angle)
        ctx.font = f"{self.size}px system-ui"
        ctx.fillStyle = "#cfe8ff"
        ctx.textAlign = "center"
        ctx.textBaseline = "middle"
        ctx.shadowColor = "rgba(130,180,255,0.6)"
        ctx.shadowBlur = 12
        ctx.fillText(self.ch, 0, 0)
        ctx.restore()

def spawn_letter():
    letters.append(Letter())

def draw_hand(open_amt):
    ctx.save()
    ctx.translate(hand_x, hand_y)
    scale = max(0.9, min(1.6, canvas.width / 1100))
    ctx.scale(scale, scale)
    grad = ctx.createRadialGradient(0, 0, 6, 0, 0, 82)
    grad.addColorStop(0, "rgba(140,180,255,0.45)")
    grad.addColorStop(1, "rgba(140,180,255,0.0)")
    ctx.fillStyle = grad
    ctx.beginPath()
    ctx.arc(0, 0, 82, 0, 2*pi)
    ctx.fill()
    ctx.fillStyle = "#ffe7d6"
    ctx.beginPath()
    ctx.arc(0, 0, 25, 0, 2*pi)
    ctx.fill()
    ctx.restore()

def clamp(v, lo, hi):
    return lo if v < lo else hi if v > hi else v

def check_collision(letter):
    r = 36
    dx = letter.x - hand_x
    dy = letter.y - hand_y
    return dx*dx + dy*dy <= r*r

def show_popup(letter):
    popup.innerText = letter
    popup.style.display = "block"
    popup_clone = popup.cloneNode(True)
    popup.parentNode.replaceChild(popup_clone, popup)
    globals()["popup"] = popup_clone
    window.setTimeout(lambda: setattr(popup_clone.style, "display", "none"), 2500)  # was 1000

def trigger_game_over():
    global game_over
    game_over = True
    bg_music.pause()
    overlay.style.display = "flex"
    final_score.innerText = str(score)
    gameover_sound.currentTime = 0
    gameover_sound.play().catch(lambda e: None)

def restart_game(event=None):
    global score, missed, frame, spawn_interval, speed_min, speed_max, letters, game_over
    score = 0
    missed = 0
    frame = 0
    spawn_interval = 48
    speed_min = 1.5
    speed_max = 3.8
    letters.clear()
    game_over = False
    overlay.style.display = "none"
    bg_music.play().catch(lambda e: None)
    window.requestAnimationFrame(loop_proxy)

restart_btn.addEventListener("click", create_proxy(restart_game))

def loop(*args):
    global frame, score, missed, best, hand_open, grab_timer, spawn_interval, speed_min, speed_max
    if game_over:
        return
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    draw_stars()
    if frame % spawn_interval == 0:
        spawn_letter()
    to_remove = []
    for i, L in enumerate(letters):
        L.update()
        L.draw()
        if L.y - 40 > canvas.height:
            to_remove.append(i)
            missed += 1
    for i in reversed(to_remove):
        letters.pop(i)
    if grab_timer > 0:
        grab_timer -= 1
        hand_open = clamp(hand_open - 0.08, 0.0, 1.0)
    else:
        hand_open = clamp(hand_open + 0.04, 0.0, 1.0)
    to_remove = []
    for i, L in enumerate(letters):
        if check_collision(L):
            if L.ch.isdigit():
                trigger_game_over()
                return
            to_remove.append(i)
            score += 1
            best = max(best, score)
            grab_timer = 10
            catch_sound.currentTime = 0
            catch_sound.play().catch(lambda e: None)
            show_popup(L.ch)
    for i in reversed(to_remove):
        letters.pop(i)
    if frame % 240 == 0 and frame > 0:
        spawn_interval = max(22, spawn_interval - 2)
        speed_min = min(3.5, speed_min + 0.05)
        speed_max = min(6.0, speed_max + 0.08)
    draw_hand(hand_open)
    hud_score.innerText = str(score)
    hud_missed.innerText = str(missed)
    hud_best.innerText = str(best)
    frame += 1
    window.requestAnimationFrame(loop_proxy)

loop_proxy = create_proxy(loop)
window.requestAnimationFrame(loop_proxy)
  </py-script>
</body>
</html>
